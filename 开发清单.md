下面是一份“**直接覆盖式重构**”的详细开发清单：不强调 V2 概念，但会明确哪些**数据结构/存储字段会变更**（因为你说无需兼容）。清单按阶段推进，每阶段都有：任务、涉及文件（新增/改/删/替换引用）、验收标准、测试点。  

> 说明：你没贴 `ProfileSession/ProfileRepository/ProfileManager` 等 profile.json 读写代码细节，所以涉及 rotations 存取的位置我只能按你当前架构推断；清单里会标注“需要在 profile 读写处对接”的改动点。

---

# 0. 总体目标与边界

## 本次重构必须达成
1) 解决实锤 bug：入口语义错误、jump_track 自跳跳过、capture 异常导致引擎停机、stop 卡死、UI 排序误导。  
2) 条件系统改为 AST：**条件/开始信号/完成信号**全部统一一套 AST（同一编译器/校验器/依赖提取/求值器）。  
3) 状态机补齐：Attempt 阶段实时可查询 + 事件时间线可复盘（UI 调试面板可展示）。  
4) 巨型文件拆分：runtime/ast/ui 关键大文件拆成可维护模块，减少重复逻辑。

## 明确将被“覆盖式改动”的东西
- rotations 存储结构会更新（字段会变，不做旧数据迁移）。
- gateway 跳转目标将改用 node_id（不再用 node_index）。
- entry 入口改为强类型（不再“entry_mode 为空自动选一个模式”）。
- 旧 groups expr 相关代码会被移除或彻底闲置。

---

# 1. 阶段拆分总览（建议按顺序）

- **P0**：新骨架落地 + 不破坏现有运行（并行搭建，旧逻辑暂时保留）
- **P1**：数据模型调整（entry、gateway target、expr 存储点）+ JSON 编解码
- **P2**：AST 子系统（codec / compiler / diagnostics / probe 提取 / evaluator）
- **P3**：CaptureManager（缓存、异常吞并、plan 由 probes 驱动）
- **P4**：StateStore + EventBus（Attempt 阶段、事件时间线、指标）
- **P5**：Executor 重写（SkillAttempt FSM + Gateway Flow + 策略化 lock/retry/complete）
- **P6**：Engine loop + Scheduler 重写（可靠 stop、严格 entry、统一 cursor）
- **P7**：Service 层对接（统一校验/引用检查；编辑服务适配 node_id）
- **P8**：UI 拆巨型文件（Editor Page/Presenter、Timeline 拆分、AST 条件编辑器、调试面板升级）
- **P9**：删除旧模块 + 全量测试 + 文档

---

# P0. 新骨架落地（不影响现有运行）

## 任务
- [ ] 在 `rotation_editor/` 内新增分层目录（不叫 v2，直接新增并逐步替换引用）：
  - `rotation_editor/ast/`
  - `rotation_editor/runtime/` 下新子包（例如 `runtime2/` 或 `runtime/new/`，名称随你，但别叫 v2 也行）
  - `rotation_editor/ui/editor/` 下新增拆分模块目录（page/presenter/timeline/conditions/debug）

## 新增文件（空壳也可）
- `rotation_editor/ast/__init__.py`
- `rotation_editor/runtime/new/__init__.py`
- `rotation_editor/ui/editor/main/__init__.py`
- `rotation_editor/ui/editor/timeline/__init__.py`
- `rotation_editor/ui/editor/conditions/__init__.py`
- `rotation_editor/ui/editor/debug/__init__.py`

## 验收
- 项目能启动，旧引擎/旧 UI 仍可运行。
- 新包可 import。

---

# P1. 数据模型覆盖式调整（入口 + 跳转目标 + expr 存储）

> 目标：一次性修掉“入口语义错、entry_track 无效、jump_target index 不可靠”。

## 任务清单
### 1) 入口 entry 强类型化
- [ ] 在 `RotationPreset` 中引入 `entry` 对象（替换/废弃 `entry_mode_id/entry_track_id`）。
- [ ] entry 必须包含：
  - scope: global 或 mode
  - mode_id（scope=mode 必填）
  - track_id（必填）
  - node_id（必填）

> 引擎启动前校验：entry 缺失直接拒绝启动（用 diagnostics 给出路径）。

### 2) gateway 跳转目标改用 node_id
- [ ] `GatewayNode` 的目标字段改为：
  - `target_mode_id`（可选）
  - `target_track_id`（jump_track 必填）
  - `target_node_id`（jump_* 必填）
- [ ] 删除或停止使用 `target_node_index`

### 3) 条件 expr 存储点统一
- [ ] `Condition.expr` 直接存 AST JSON（而不是 groups dict）
- [ ] `GatewayNode` 支持：
  - `condition_ref`（引用条件 id）或
  - `condition_expr`（内联 AST JSON）
  二选一（都支持也行，但要定优先级）

### 4) JSON 编解码严格化
- [ ] 所有 from_dict 遇到不合法字段：不 silent pass；改为产生 diagnostics 或直接抛并由上层捕获为 diagnostics。
- [ ] rotations 根对象 `schema_version` 仍可保留，但不需要提“v2”；你也可以直接删掉版本字段，反正不兼容。

## 涉及文件（改动）
- `rotation_editor/core/models/preset.py`（或你最终决定新的模型文件）
- `rotation_editor/core/models/node.py`（GatewayNode 字段变更）
- `rotation_editor/core/models/rotations_file.py`
- Profile 的 rotations 读写处（你没贴）：需要更新字段映射

## 验收
- 新建/保存 profile 后 rotations 结构包含 entry 且格式正确。
- 旧数据打开可以直接报错“不支持旧 rotations 格式”（不做迁移）。
- UI 能编辑并保存 entry（P8 会补 UI）。

---

# P2. AST 子系统（替换 groups expr，全栈统一）

> 目标：校验、引用检查、probes、求值都走同一套 AST。以后加 atom 不再改四处。

## 任务清单
### 1) AST 节点与 JSON codec
- [ ] 实现布尔节点：`and/or/not/const`
- [ ] 实现原子节点（先覆盖现有 + 你缺口核心）：
  - PixelMatchPoint(point_id, tol)
  - PixelMatchSkill(skill_id, tol)  （用 skill.pixel）
  - SkillMetricGE(skill_id, metric, n)（success/attempt_started/key_sent_ok/cast_started/fail）
  - CastBarChanged(point_id, tol)（开始信号用）
  - （可选）PixelDiffPointGE / CastBarAppear 等更明确原子

### 2) Diagnostics（统一错误体系）
- [ ] `Diagnostic(code, level, path, message, detail)`
- [ ] compiler 产出 diagnostics；UI/validator/engine 都用它

### 3) Compiler（静态校验 + 依赖提取入口）
- [ ] 校验：
  - node 类型合法
  - point_id/skill_id 存在（需要传 ProfileContext）
  - tol/count 范围合法
- [ ] 产出 `CompiledExpr`（强类型节点）+ `ProbeRequirements`（依赖点位/技能像素）

### 4) Evaluator（运行时求值）
- [ ] 输入：`snapshot + compiled_expr + state_store_view`
- [ ] 输出：`bool | unknown`（建议支持 unknown；由上层策略决定 unknown=fail 或重试）
- [ ] 关键：Evaluator 不做截屏；只用 snapshot

## 新增文件建议
- `rotation_editor/ast/nodes.py`
- `rotation_editor/ast/codec.py`
- `rotation_editor/ast/diagnostics.py`
- `rotation_editor/ast/compiler.py`
- `rotation_editor/ast/probes.py`
- `rotation_editor/ast/evaluator.py`

## 替换/废弃目标（先停止引用，P9 再删）
- `rotation_editor/core/runtime/condition_eval.py`
- `rotation_editor/core/analysis/reference_check.py`
- ConditionEditorDialog 内的手写校验逻辑（P8 替换为 compiler diagnostics）

## 验收
- 输入一段 expr JSON：
  - compiler 能找出缺失引用并给出 path
  - probe requirements 可用于构建 capture plan
  - evaluator 能在给定 snapshot 下返回 True/False（并支持 unknown）

---

# P3. CaptureManager（缓存 snapshot + 异常吞并，不再让引擎崩）

## 任务清单
- [ ] plan_builder：由 ProbeRequirements 构建 ROI/full（替换你现在 collect_probes/build_capture_plan 的分散扫描）
- [ ] capture_manager：
  - 缓存最近 snapshot（例如 20~50ms 内复用）
  - 捕获异常吞并：返回 `CaptureUnavailable`，同时写事件（给 StateStore）
  - backoff：连续失败延长下一次 capture 间隔（防止 busy loop）

## 新增文件建议
- `rotation_editor/runtime/new/capture/plan_builder.py`
- `rotation_editor/runtime/new/capture/manager.py`

## 替换目标
- `rotation_editor/core/runtime/capture_plan.py`
- `NodeExecutor.mk_rt_ctx()` 这类“执行中随处 capture”逻辑将被移除

## 验收
- 屏幕 capture 抛异常时：
  - 引擎不中断（不 crash）
  - 状态机记录 capture_unavailable
  - 恢复后自动继续

---

# P4. StateStore + EventBus（实时阶段 + 时间线复盘）

> 目标：把你现在“统计 + current + recent”升级为“可查询的状态机对象 + 事件时间线”，并成为 runtime 唯一真相源。

## 任务清单
### 1) 事件定义
- [ ] EngineEvent：STARTED/STOPPING/STOPPED/ERROR/PAUSED/RESUMED
- [ ] AttemptEvent：阶段进入/离开、采样结果（diff/tol）、发键结果、retry、失败原因
- [ ] CaptureEvent：plan 更新、capture 成功/失败、snapshot_age

### 2) Store 结构
- [ ] `EngineState`（running/paused/reason/current_cursor/last_error）
- [ ] `AttemptState`（attempt_id -> events + current_stage + timestamps + retry_index）
- [ ] `SkillAggregateState`（按 skill_id 聚合指标 + current_attempt_id）

### 3) 查询 API（UI 专用快照）
- [ ] `snapshot_skills()`：表格所需字段
- [ ] `get_attempts(skill_id, n)`
- [ ] `get_timeline(attempt_id)`：事件列表（用于新的时间线窗口）

## 新增文件建议
- `rotation_editor/runtime/new/state/events.py`
- `rotation_editor/runtime/new/state/store.py`
- `rotation_editor/runtime/new/state/metrics.py`

## 验收
- 能精确展示：
  - 当前 skill 阶段：READY_CHECK/PREPARING/CASTING/…
  - 阶段持续时间、retry_index
  - 最近 attempt 事件时间线（包含采样 diff、失败原因）

---

# P5. Executor 重写（技能 Attempt FSM + 网关 Flow，策略化）

> 目标：把现在巨大 `executor.py` 拆分，同时完成你缺口：严格 start/complete、Timer timeout 可选、锁忙策略可选、失败原因细分。

## 任务清单
### 1) SkillAttempt FSM（核心）
阶段建议：READY_CHECK → LOCK_WAIT → PREPARING → START_WAIT → CASTING → COMPLETE_WAIT → SUCCESS/FAILED  
- [ ] ready 判定：用 AST（比如 PixelMatchSkill 或未来可配置 ready_expr）
- [ ] start 判定：start_expr（AST，可 OR/AND 组合；pixel/cast_bar/none 都能表达）
- [ ] complete 判定：complete_expr（AST）+ completion_policy：
  - ASSUME_SUCCESS（到时成功）
  - REQUIRE_SIGNAL（必须满足 complete_expr，否则 timeout fail）
  - HYBRID（超时可 fallback 成成功或失败）
- [ ] retry_policy：start_timeout 内 start_expr 不成立 -> retry；超过 max_retries -> fail(no_cast_start)
- [ ] lock_policy（可配置）：
  - SKIP_AND_ADVANCE（你现在行为）
  - WAIT_LOCK（不推进，等锁直到超时或成功）
  - SKIP_BUT_HOLD（不推进，下轮还打这个节点）
- [ ] capture unavailable 策略：unknown 处理（例如：unknown 计一次 capture_fail 并延后重试）

### 2) Gateway 执行（FlowResult）
- [ ] condition：引用 condition 或内联 expr（AST）
- [ ] action：
  - end：stop
  - jump_node：同轨道 node_id
  - jump_track：目标 track_id + node_id
  - switch_mode：切换 scope（可选指定 track_id/node_id）
- [ ] 明确规则：jump 不再额外 advance（根除自跳跳过 bug）

## 新增文件建议
- `rotation_editor/runtime/new/executor/skill_executor.py`
- `rotation_editor/runtime/new/executor/gateway_executor.py`
- `rotation_editor/runtime/new/policies/lock_policy.py`
- `rotation_editor/runtime/new/policies/retry_policy.py`
- `rotation_editor/runtime/new/policies/completion_policy.py`

## 替换目标（停用旧实现）
- `rotation_editor/core/runtime/executor.py`
- `rotation_editor/core/runtime/cast_strategies.py`
- `rotation_editor/core/runtime/gateway_actions.py`

## 验收
- start_expr 可组合：任一信号成立进入 CASTING
- Timer 模式可实现“真实 timeout fail”（REQUIRE_SIGNAL）
- 锁忙策略三种行为符合定义且可测
- 网关自跳不会跳过目标节点

---

# P6. Engine + Scheduler 重写（严格 entry、可靠 stop、统一 cursor）

> 目标：修掉 engine 层的入口语义错、stop 卡死、调度与副作用耦合。

## 任务清单
### 1) Scheduler 独立
- [ ] 输入：tracks 状态（next_time、cursor）、paused/step、策略
- [ ] 输出：下一条执行项或 sleep 时间

### 2) Cursor 用 node_id
- [ ] TrackRuntimeState 保存 `current_node_id`
- [ ] 维护 `node_id -> index` 映射仅用于数组访问（可每次更新或预构建）

### 3) entry 严格执行
- [ ] 引擎启动必须从 entry 指定位置开始（不再自动选模式）
- [ ] entry 指向不存在的 track/node：启动校验直接拒绝

### 4) stop 可靠
- [ ] stop 后 engine_state 立刻标记 STOPPING（不依赖线程 finally）
- [ ] join 超时不丢线程引用，可再次 join
- [ ] UI 判断以 engine_state 为准，不再依赖 `_running` 这种脆弱字段

## 新增文件建议
- `rotation_editor/runtime/new/scheduler.py`
- `rotation_editor/runtime/new/engine.py`
- `rotation_editor/runtime/new/runtime_state.py`

## 替换目标
- `rotation_editor/core/runtime/engine.py`
- `rotation_editor/core/runtime/state.py`

## 验收
- 点击停止后 UI 可立刻再次启动，不会卡死
- entry 不完整/无效时拒绝启动并给 diagnostics
- capture 异常时引擎不崩

---

# P7. Service 层对接（统一校验/引用检查，编辑适配 node_id/entry）

## 任务清单
- [ ] RotationService / RotationEditService 覆盖式适配新模型字段：
  - preset CRUD
  - entry 设置
  - gateway target 选择 node_id
- [ ] 新增 ValidationService：
  - 遍历 preset 中所有 expr（conditions、gateway 条件、start/complete 等）
  - compiler compile 并汇总 diagnostics
  - 引擎启动前调用：有 error -> 拒绝启动并展示详细路径
- [ ] “检查引用”按钮：直接展示 diagnostics（缺 skill/point）

## 改动文件
- `rotation_editor/core/services/rotation_service.py`
- `rotation_editor/core/services/rotation_edit_service.py`
- `rotation_editor/ui/presets_page.py`（引用检查从 analyze_preset_references 改为 ValidationService 报告）

## 停用目标
- `rotation_editor/core/runtime/validation.py`（PresetValidator）
- `rotation_editor/core/analysis/reference_check.py`

## 验收
- UI 引用检查与启动校验共用一套 diagnostics（无重复逻辑）
- 轨道/节点编辑不会再依赖 node_index 作为跳转目标

---

# P8. UI 拆巨型文件 + AST 条件编辑器 + Timeline 一致性

> 这里是维护性改造重点：把 `main_page.py / timeline_canvas.py / condition_dialog.py` 拆分，且让 UI 排布与 runtime 顺序一致。

## 8.1 Editor 主页拆分（Page + Presenter + ViewState）
- [ ] `RotationEditorPage` 拆为：
  - `ui/editor/main/page.py`（只管布局和信号）
  - `ui/editor/main/presenter.py`（业务逻辑、引擎控制、与 services 对接）
  - `ui/editor/main/view_state.py`（当前选择 preset/mode/track/node）
- [ ] 引擎回调（on_started/on_node_executed/on_error）交由 presenter 处理

## 8.2 Timeline 拆分（绘制/布局/交互解释）
- [ ] `timeline/canvas.py`：只做 QGraphicsView 绘制 + drag 手势，输出“用户意图事件”
- [ ] `timeline/layout.py`：布局计算必须纳入：
  - `step_index`
  - `order_in_step`（解决同 step 重叠/误导问题）
- [ ] `timeline/interaction.py`：把 drag 解释为：
  - 同轨：改 step/order
  - 跨轨：move node（node_id 不变）
- [ ] 统一排序函数放到共享模块，UI 与 runtime 共用（避免再次不一致）

## 8.3 条件编辑器改为 AST 编辑器（可先做“规则列表 UI”，底层存 AST）
- [ ] `conditions/dialog.py`：界面
- [ ] `conditions/vm.py`：把“规则列表”映射成 AST（And/Or/Not + atoms）
- [ ] 校验：直接调用 compiler，显示 diagnostics（标红/tooltip）
- [ ] 支持编辑：
  - Condition 的 expr
  - 网关的 condition_expr 或 condition_ref
  - 技能节点的 start_expr/complete_expr（可以放 NodePropertiesDialog 里）

> 你现有 ConditionEditorDialog 的手写校验逻辑会彻底移除，避免重复。

## 8.4 Debug 面板升级（加入 attempt 时间线）
- [ ] 保留统计表
- [ ] 新增“Attempt 时间线对话框”：选择 attempt_id 展示事件列表（阶段、采样 diff、失败原因）
- [ ] 面板数据来源改为 StateStore 查询 API

## 8.5 NodePropertiesDialog 改造
- [ ] 网关跳转目标下拉：选择 node_id（展示 label + id 后 6 位）
- [ ] entry 设置 UI：选择 scope/mode/track/node（都按 id）

## 涉及文件（替换/拆分）
- 替换：`rotation_editor/ui/editor/main_page.py`（拆掉）
- 拆分：`rotation_editor/ui/editor/timeline_canvas.py`
- 替换：`rotation_editor/ui/editor/condition_dialog.py`
- 改：`rotation_editor/ui/editor/node_props_dialog.py`
- 改：`rotation_editor/ui/editor/debug_stats_dialog.py`（接入 timeline）

## 验收
- Timeline 同 step 多节点不重叠，顺序与 runtime 一致
- 条件编辑错误提示来自 compiler diagnostics（唯一来源）
- Debug 面板能看到当前 attempt 阶段、retry_index、阶段耗时、关键采样值与事件时间线

---

# P9. 清理旧模块 + 全量测试 + 文档

## 9.1 删除/停用清单（确认新逻辑已接管后）
建议最终删除或断开引用（保留也行，但别再被 import）：
- `rotation_editor/core/runtime/condition_eval.py`
- `rotation_editor/core/runtime/cast_strategies.py`
- `rotation_editor/core/runtime/executor.py`
- `rotation_editor/core/runtime/gateway_actions.py`
- `rotation_editor/core/runtime/state.py`
- `rotation_editor/core/runtime/validation.py`
- `rotation_editor/core/analysis/reference_check.py`
- 旧 UI：`ui/editor/main_page.py` / `timeline_canvas.py` / `condition_dialog.py`（由新拆分模块替代）

## 9.2 必做测试清单（建议 unittest）
- [ ] entry 严格：缺 entry/无效 node_id -> 启动拒绝（diagnostics path 正确）
- [ ] jump_track 自跳：不会跳过目标 node
- [ ] capture 异常：引擎不崩、记录事件、恢复后继续
- [ ] lock_policy 三策略：推进/等待/保持 cursor 行为正确
- [ ] start_expr OR：任一信号成立进入 CASTING
- [ ] completion_policy REQUIRE：Timer 下无完成信号 -> timeout fail（reason=complete_signal_missing/timeout 分清）
- [ ] UI 排布与排序一致性：同 step 多节点不重叠且顺序正确

## 9.3 文档（最少三份）
- `docs/rotations_schema.md`（当前 rotations 数据结构与字段语义）
- `docs/ast_expr.md`（AST 节点类型、示例、求值语义）
- `docs/debugging.md`（如何用 attempt 时间线定位问题）

---

# 建议的“开工顺序”（避免 UI/引擎互相拖累）
1) P1（模型/存储）→ P2（AST）先做完：它们是所有层依赖  
2) P3（CaptureManager）+ P4（StateStore）搭地基：稳定性与可观测性先到位  
3) P5/P6（executor/engine/scheduler）先跑通**纯单测**（无 UI）  
4) P7（services）统一校验与引用检查  
5) P8（UI 拆分与对接）  
6) P9（删旧逻辑 + 补测试 + 写文档）

---

如果你希望这份清单进一步细到“每个模块的类名/方法签名/线程边界/事件字段表”，我可以直接给一个 implementation spec（类似 RFC），让不同人并行开发时不互相撞接口。